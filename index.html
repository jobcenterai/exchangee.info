<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Matte Chat</title>

<style>
:root{
--bg:#0f172a;
--panel:#1e293b;
--accent:#3b82f6;
--soft:#334155;
--text:#e2e8f0;
--danger:#ef4444;
}

body{
margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto;
background:var(--bg);
color:var(--text);
display:flex;
height:100vh;
}

/* Sidebar */
.sidebar{
width:240px;
background:var(--panel);
padding:20px;
display:flex;
flex-direction:column;
gap:10px;
border-right:1px solid var(--soft);
}

.group{
padding:8px 10px;
background:var(--soft);
border-radius:8px;
cursor:pointer;
font-size:14px;
transition:.2s;
}

.group:hover{
background:var(--accent);
}

button{
background:var(--accent);
border:none;
padding:8px;
border-radius:8px;
cursor:pointer;
color:white;
font-weight:600;
}

button:hover{
opacity:.85;
}

/* Chat */
.chat{
flex:1;
display:flex;
flex-direction:column;
padding:25px;
gap:10px;
}

.chat-header{
font-size:18px;
font-weight:600;
}

.chat-box{
flex:1;
background:var(--panel);
border-radius:12px;
padding:15px;
overflow:auto;
display:flex;
flex-direction:column;
gap:8px;
}

.msg{
background:var(--soft);
padding:8px 10px;
border-radius:8px;
font-size:14px;
max-width:70%;
}

textarea{
resize:none;
padding:10px;
border-radius:10px;
border:1px solid var(--soft);
background:var(--panel);
color:var(--text);
font-size:14px;
}

.status{
font-size:13px;
height:18px;
}

.error{
color:var(--danger);
}

.success{
color:#22c55e;
}
</style>
</head>
<body>

<div class="sidebar">
<h3>Groups</h3>
<div id="groupList"></div>
<button onclick="createGroup()">+ Create</button>
<button onclick="joinGroup()">Join</button>
</div>

<div class="chat">
<div class="chat-header" id="chatTitle">No Group Selected</div>
<div class="chat-box" id="chatBox"></div>

<textarea id="messageInput" rows="3" placeholder="Type message..."></textarea>
<button onclick="sendMessage()">Send Encrypted</button>
<button onclick="decryptAll()">Decrypt</button>

<div class="status" id="status"></div>
</div>

<script>
let groups = {};
let currentGroup = null;
let currentKey = null;

function setStatus(text,type=""){
const el=document.getElementById("status");
el.className="status "+type;
el.innerText=text;
}

async function deriveKey(password){
const enc=new TextEncoder();
const mat=await crypto.subtle.importKey(
"raw",enc.encode(password),
"PBKDF2",false,["deriveKey"]
);
return await crypto.subtle.deriveKey({
name:"PBKDF2",
salt:enc.encode("cleanSalt"),
iterations:100000,
hash:"SHA-256"
},
mat,
{name:"AES-GCM",length:256},
false,
["encrypt","decrypt"]
);
}

function refreshGroups(){
const list=document.getElementById("groupList");
list.innerHTML="";
for(let name in groups){
const div=document.createElement("div");
div.className="group";
div.innerText=name;
div.onclick=()=>openGroup(name);
list.appendChild(div);
}
}

async function createGroup(){
const name=prompt("Group name:");
const pass=prompt("Password:");
if(!name||!pass)return;

groups[name]={messages:[]};
currentKey=await deriveKey(pass);
currentGroup=name;
refreshGroups();
openGroup(name);
setStatus("Group created","success");
}

async function joinGroup(){
const name=prompt("Group name:");
const pass=prompt("Password:");
if(!groups[name]){
setStatus("Group not found","error");
return;
}
currentKey=await deriveKey(pass);
currentGroup=name;
openGroup(name);
setStatus("Joined group","success");
}

function openGroup(name){
currentGroup=name;
document.getElementById("chatTitle").innerText=name;
display();
}

async function sendMessage(){
if(!currentGroup||!currentKey){
setStatus("Join a group first","error");
return;
}

const text=document.getElementById("messageInput").value;
if(!text)return;

const iv=crypto.getRandomValues(new Uint8Array(12));
const encoded=new TextEncoder().encode(text);
const encrypted=await crypto.subtle.encrypt(
{name:"AES-GCM",iv},
currentKey,
encoded
);

groups[currentGroup].messages.push({
iv:Array.from(iv),
data:Array.from(new Uint8Array(encrypted))
});

document.getElementById("messageInput").value="";
display();
setStatus("Message encrypted","success");
}

function display(){
const box=document.getElementById("chatBox");
box.innerHTML="";
if(!currentGroup)return;

groups[currentGroup].messages.forEach(()=>{
const div=document.createElement("div");
div.className="msg";
div.innerText="Encrypted message";
box.appendChild(div);
});
}

async function decryptAll(){
if(!currentGroup||!currentKey){
setStatus("Join a group first","error");
return;
}

const box=document.getElementById("chatBox");
box.innerHTML="";

for(let m of groups[currentGroup].messages){
try{
const iv=new Uint8Array(m.iv);
const decrypted=await crypto.subtle.decrypt(
{name:"AES-GCM",iv},
currentKey,
new Uint8Array(m.data)
);

const text=new TextDecoder().decode(decrypted);

const div=document.createElement("div");
div.className="msg";
div.innerText=text;
box.appendChild(div);

}catch{
setStatus("Wrong password or corrupted message","error");
return;
}
}

setStatus("Decrypted successfully","success");
}
</script>

</body>
</html>
